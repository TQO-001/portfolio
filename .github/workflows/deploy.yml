name: Deploy Portfolio

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üìã Checkout Code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üèóÔ∏è Install & Build
        run: |
          npm ci
          npm run build
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

      - name: üöö Sync Files to VPS
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: "laughtale.co.za"
          REMOTE_USER: "laughtale"
          REMOTE_PORT: ${{ secrets.PORT }}
          TARGET: "/var/www/portfolio"
          SOURCE: "./"
          # -e 'ssh -p ...' forces rsync to use your custom SSH port 2222
          ARGS: "-rlgoDzvc -i --delete -e 'ssh -p ${{ secrets.PORT }}' --exclude='.git' --exclude='node_modules' --exclude='src'"

      - name: üöÄ Production Launch & Restart
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: "laughtale.co.za"
          username: "laughtale"
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /var/www/portfolio
            
            # Use APP_PORT (3002) for the .env
            cat << EOF > .env
            RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}"
            PORT=${{ secrets.APP_PORT }}
            NODE_ENV="production"
            EOF
            
            # Install production dependencies
            npm install --omit=dev --ignore-scripts
            
            # Restart with the specific app port
            pm2 delete portfolio || true
            pm2 start npm --name "portfolio" -- start -- -p ${{ secrets.APP_PORT }}
            pm2 save

      - name: ‚úÖ Health Check
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: "laughtale.co.za"
          username: "laughtale"
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            sleep 10
            # Check the website port (3002)
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${{ secrets.APP_PORT }} || echo "000")
            
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "307" ] || [ "$STATUS" = "302" ]; then
              echo "‚úÖ Portfolio is LIVE on port ${{ secrets.APP_PORT }} (HTTP $STATUS)"
            else
              echo "‚ùå Health check failed (HTTP $STATUS)"
              pm2 logs portfolio --lines 20 --nostream
              exit 1
            fi