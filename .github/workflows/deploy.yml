name: Deploy Portfolio

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üìã Checkout Code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üèóÔ∏è Install & Build
        run: |
          npm ci
          npm run build
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

      - name: üöö Sync Files to VPS
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: "laughtale.co.za"
          REMOTE_USER: "laughtale"
          REMOTE_PORT: "2222"
          TARGET: "/var/www/portfolio"
          SOURCE: "./"
          # Exclude source code and git junk; keep build artifacts (like .next or dist)
          ARGS: "-rlgoDzvc -i --delete --exclude='.git' --exclude='node_modules' --exclude='src'"

      - name: üöÄ Production Launch & Restart
        uses: appleboy/ssh-action@master
        with:
          host: "laughtale.co.za"
          username: "laughtale"
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2222
          script: |
            cd /var/www/portfolio
            
            # Create/Update .env securely
            cat << EOF > .env
            RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}"
            NODE_ENV="production"
            EOF
            
            # Install production dependencies only to save space/time
            npm install --omit=dev --ignore-scripts
            
            # Restart the PM2 process
            pm2 delete portfolio || true
            pm2 start npm --name "portfolio" -- start
            pm2 save

      - name: ‚úÖ Health Check
        uses: appleboy/ssh-action@master
        with:
          host: "laughtale.co.za"
          username: "laughtale"
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2222
          script: |
            sleep 5
            # Adjust the port (3000) if your portfolio runs on a different one
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "307" ] || [ "$STATUS" = "302" ]; then
              echo "‚úÖ Portfolio is LIVE (HTTP $STATUS)"
            else
              echo "‚ùå Health check failed (HTTP $STATUS)"
              pm2 status portfolio
              pm2 logs portfolio --lines 20 --nostream
              exit 1
            fi